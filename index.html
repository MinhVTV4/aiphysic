<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic & Matter.js - Th√≠ Nghi·ªám V·∫≠t L√Ω AI (M·∫∑t Ph·∫≥ng Nghi√™ng)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style type="text/tailwindcss">
        .spinner-border { display: inline-block; width: 2rem; height: 2rem; vertical-align: text-bottom; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; -webkit-animation: spinner-border .75s linear infinite; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .spinner-sm { width: 1rem; height: 1rem; border-width: .2em; }
        #matterJsSection { display: flex; flex-direction: column; }
        #canvasContainer { flex-grow: 1; min-height: 300px; }
        .auth-form { display: none; } 
        .auth-form.active { display: block; }
        #aiExplanationContainer {
            background-color: #eef2ff;
            border-left: 4px solid #6366f1;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: #4338ca;
        }
        #chartsSection {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        .export-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 119, 255, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10;
        }
        .export-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-3 sm:p-4 selection:bg-blue-200">
    <header class="w-full max-w-6xl mb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-600 py-2">
            Ph√≤ng Th√≠ Nghi·ªám V·∫≠t L√Ω AI
        </h1>
    </header>

    <section id="authSection" class="w-full max-w-md bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-lg font-semibold text-center text-sky-700 mb-3">T√†i Kho·∫£n Ng∆∞·ªùi D√πng</h2>
        <div id="userStatusContainer" class="text-center text-sm mb-3">
            <p id="userStatusText">ƒêang t·∫£i tr·∫°ng th√°i ng∆∞·ªùi d√πng...</p>
            <button id="signOutButton" class="hidden mt-1 text-xs bg-rose-500 hover:bg-rose-600 text-white py-1 px-3 rounded-md transition-colors">ƒêƒÉng Xu·∫•t</button>
        </div>
        <div id="authFormsContainer">
            <form id="loginForm" class="auth-form space-y-3 p-3 bg-slate-50 rounded-lg">
                <h3 class="text-md font-medium text-slate-700">ƒêƒÉng Nh·∫≠p</h3>
                <div><label for="loginEmail" class="block text-xs font-medium text-slate-600">Email</label><input type="email" id="loginEmail" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <div><label for="loginPassword" class="block text-xs font-medium text-slate-600">M·∫≠t kh·∫©u</label><input type="password" id="loginPassword" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <button type="submit" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">ƒêƒÉng Nh·∫≠p</button>
                <p class="text-xs text-center">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="showSignUpLink" class="text-blue-600 hover:underline">ƒêƒÉng k√Ω</a></p>
            </form>
            <form id="signUpForm" class="auth-form space-y-3 p-3 bg-slate-50 rounded-lg">
                <h3 class="text-md font-medium text-slate-700">ƒêƒÉng K√Ω</h3>
                <div><label for="signUpEmail" class="block text-xs font-medium text-slate-600">Email</label><input type="email" id="signUpEmail" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <div><label for="signUpPassword" class="block text-xs font-medium text-slate-600">M·∫≠t kh·∫©u</label><input type="password" id="signUpPassword" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <button type="submit" class="w-full text-sm bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">ƒêƒÉng K√Ω</button>
                <p class="text-xs text-center">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="showLoginLink" class="text-green-600 hover:underline">ƒêƒÉng nh·∫≠p</a></p>
            </form>
            <p id="authStatus" class="text-xs text-center mt-2 min-h-[16px]"></p>
        </div>
    </section>

    <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6 px-2 flex-grow">
        <section id="aiControlsSection" class="bg-white p-5 rounded-xl shadow-xl lg:col-span-1 order-2 lg:order-1 flex flex-col">
            <h2 class="text-xl font-semibold text-center mb-1 text-blue-700"><span role="img" aria-label="robot" class="mr-2">ü§ñ</span>ƒêi·ªÅu Khi·ªÉn AI</h2>
            <p class="text-center text-xs text-slate-500 mb-4">(Model: gemini-1.5-flash-latest)</p>
            <textarea id="promptInput" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y text-sm shadow-sm mb-3" placeholder="M√¥ t·∫£ th√≠ nghi·ªám, v√≠ d·ª•: 'Th·∫£ m·ªôt kh·ªëi h·ªôp tr∆∞·ª£t tr√™n m·∫∑t ph·∫≥ng nghi√™ng 30 ƒë·ªô'"></textarea>
            <div class="flex space-x-2 mb-3">
                <button id="sendPromptButton" class="flex-grow py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all duration-150 ease-in-out text-sm">
                    <span id="buttonText">T·∫°o Th√≠ Nghi·ªám</span>
                    <div id="buttonSpinner" class="spinner-sm spinner-border hidden" role="status"></div>
                </button>
                <button id="saveExperimentButton" title="L∆∞u c·∫•u h√¨nh th√≠ nghi·ªám hi·ªán t·∫°i (JSON t·ª´ AI)" class="py-2.5 px-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors text-sm" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7.5 2.813A2.5 2.5 0 005 5.237V14.763a2.5 2.5 0 002.5 2.424l8-1.23A2.5 2.5 0 0018 13.537V4.463a2.5 2.5 0 00-2.5-2.424l-8-1.23zM16.5 4.463v9.074l-8 1.23V5.693l8-1.23z"/><path d="M5 16.187A1 1 0 014 15.187V4.813a1 1 0 011.5-.866l8 1.231a1 1 0 01.5.866v9.074a1 1 0 01-1.5.866l-8-1.231zM6 5.877v8.246l7 .923V6.8l-7-.923z" clip-rule="evenodd" fill-rule="evenodd"/></svg>
                </button>
            </div>
            <p id="statusMessage" class="mt-1 font-medium text-xs text-center text-slate-600 min-h-[18px]"></p>
            <div id="responseContainer" class="mt-1 p-3 border border-slate-200 bg-slate-50 rounded-lg min-h-[80px] whitespace-pre-wrap break-words text-xs text-slate-700 shadow-inner relative flex items-center justify-center transition-colors flex-grow overflow-auto">Ph·∫£n h·ªìi c·ªßa AI s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
            <div id="aiExplanationContainer" class="hidden"><h4 class="font-semibold text-sm mb-1">Gi·∫£i th√≠ch t·ª´ AI:</h4><p id="aiExplanationText" class="text-xs"></p></div>
        </section>

        <section id="matterJsSection" class="bg-white p-5 rounded-xl shadow-xl lg:col-span-2 order-1 lg:order-2 flex flex-col">
            <h2 class="text-xl font-semibold text-center mb-2 text-blue-700"><span role="img" aria-label="atom" class="mr-2">‚öõÔ∏è</span>Kh√¥ng Gian Th√≠ Nghi·ªám</h2>
            <div id="canvasContainer" class="w-full bg-slate-200 rounded-lg shadow-inner overflow-hidden mx-auto"></div>
            <p id="matterStatus" class="text-center text-xs text-slate-500 mt-2 min-h-[18px]">ƒêang t·∫£i Matter.js...</p>
            <div class="mt-3 grid grid-cols-3 gap-2">
                <button id="addBoxButton" class="py-2 px-2 bg-sky-500 text-white font-medium rounded-md hover:bg-sky-600 transition-colors text-xs shadow disabled:bg-sky-300">Th√™m H·ªôp (Th·ªß c√¥ng)</button>
                <button id="addCircleButton" class="py-2 px-2 bg-teal-500 text-white font-medium rounded-md hover:bg-teal-600 transition-colors text-xs shadow disabled:bg-teal-300">Th√™m Tr√≤n (Th·ªß c√¥ng)</button>
                <button id="resetSimulationButton" class="py-2 px-2 bg-rose-500 text-white font-medium rounded-md hover:bg-rose-600 transition-colors text-xs shadow disabled:bg-rose-300">Reset M√¥ Ph·ªèng</button>
            </div>
            
            <div id="chartsSection" class="mt-6 p-4 bg-white rounded-xl shadow-lg">
                <h3 class="text-md font-semibold text-center text-sky-700 mb-3">ƒê·ªì Th·ªã D·ªØ Li·ªáu</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="chart-container">
                        <canvas id="heightChartCanvas"></canvas>
                        <button id="exportHeightChart" class="export-btn" disabled>T·∫£i xu·ªëng</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="velocityYChartCanvas"></canvas>
                        <button id="exportVelocityYChart" class="export-btn" disabled>T·∫£i xu·ªëng</button>
                    </div>
                </div>
                 <p id="chartStatus" class="text-center text-xs text-slate-500 mt-2 min-h-[18px]">Ch·ªçn th√≠ nghi·ªám ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªì th·ªã.</p>
            </div>
        </section>
    </main>
    
    <footer class="w-full max-w-6xl mt-8 mb-4 text-center text-xs text-slate-500">
        <p>&copy; 2024 - Ph√≤ng th√≠ nghi·ªám V·∫≠t l√Ω AI.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMNnx2yS-yeH_N7m_pCaVInqV2RZG7HSY",
            authDomain: "aiphysic.firebaseapp.com",
            projectId: "aiphysic",
            storageBucket: "aiphysic.appspot.com",
            messagingSenderId: "922235658911",
            appId: "1:922235658911:web:5dc24f88c82667e0e478aa"
        };

        const app = initializeApp(firebaseConfig);
        const ai = getAI(app, { backend: new GoogleAIBackend() });
        const aiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SYSTEM PROMPTS ---

        const SYSTEM_PROMPT_FREE_FALL = `B·∫°n l√† m·ªôt AI chuy√™n gia v·ªÅ v·∫≠t l√Ω, c√≥ nhi·ªám v·ª• chuy·ªÉn ƒë·ªïi c√°c y√™u c·∫ßu m√¥ ph·ªèng th√≠ nghi·ªám v·∫≠t l√Ω b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n c·ªßa ng∆∞·ªùi d√πng th√†nh m·ªôt ƒë·ªãnh d·∫°ng JSON c·ª• th·ªÉ ƒë·ªÉ s·ª≠ d·ª•ng trong m·ªôt c√¥ng c·ª• m√¥ ph·ªèng v·∫≠t l√Ω 2D (d·ª±a tr√™n Matter.js). Ph·∫£n h·ªìi CH·ªà ƒë∆∞·ª£c l√† JSON.

Lo·∫°i th√≠ nghi·ªám: R∆†I T·ª∞ DO
H∆∞·ªõng d·∫´n cho "dimensions_m": Ch·ªâ cung c·∫•p "radius" n·∫øu "shape" l√† "circle". Ch·ªâ cung c·∫•p "width" v√† "height" n·∫øu "shape" l√† "rectangle".
L∆ØU √ù QUAN TR·ªåNG cho "aiExplanation": KH√îNG s·ª≠ d·ª•ng d·∫•u ngo·∫∑c k√©p (") b√™n trong chu·ªói gi·∫£i th√≠ch. H√£y d√πng d·∫•u ngo·∫∑c ƒë∆°n (') ho·∫∑c c√°c t·ª´ ƒë·ªìng nghƒ©a thay th·∫ø.
C·∫•u tr√∫c JSON m·∫´u:
{
  "experimentType": "free_fall",
  "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám.",
  "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 },
  "objects": [
    {
      "id": "object_1",
      "label": "T√™n v·∫≠t",
      "shape": "circle",
      "mass_kg": 0.5,
      "dimensions_m": {
        "radius": 0.1
      },
      "initialPosition_m": {
        "x": 2.5,
        "y_from_ground": 10
      },
      "physicalProperties": {
        "restitution": 0.6,
        "friction": 0.1,
        "frictionAir": 0.01
      },
      "color": "#3498db"
    }
  ],
  "aiExplanation": "Gi·∫£i th√≠ch ng·∫Øn v·ªÅ th√≠ nghi·ªám v√† c√°c th√¥ng s·ªë."
}`;
        const SYSTEM_PROMPT_PROJECTILE_MOTION = `B·∫°n l√† m·ªôt AI chuy√™n gia v·ªÅ v·∫≠t l√Ω, c√≥ nhi·ªám v·ª• chuy·ªÉn ƒë·ªïi c√°c y√™u c·∫ßu m√¥ ph·ªèng th√≠ nghi·ªám v·∫≠t l√Ω b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n c·ªßa ng∆∞·ªùi d√πng th√†nh m·ªôt ƒë·ªãnh d·∫°ng JSON c·ª• th·ªÉ ƒë·ªÉ s·ª≠ d·ª•ng trong m·ªôt c√¥ng c·ª• m√¥ ph·ªèng v·∫≠t l√Ω 2D (d·ª±a tr√™n Matter.js). Ph·∫£n h·ªìi CH·ªà ƒë∆∞·ª£c l√† JSON.

Lo·∫°i th√≠ nghi·ªám: CHUY·ªÇN ƒê·ªòNG N√âM (N√âM XI√äN, N√âM NGANG)
H∆∞·ªõng d·∫´n cho "dimensions_m": Ch·ªâ cung c·∫•p "radius" n·∫øu "shape" l√† "circle". Ch·ªâ cung c·∫•p "width" v√† "height" n·∫øu "shape" l√† "rectangle".
L∆ØU √ù QUAN TR·ªåNG cho "aiExplanation": KH√îNG s·ª≠ d·ª•ng d·∫•u ngo·∫∑c k√©p (") b√™n trong chu·ªói gi·∫£i th√≠ch. H√£y d√πng d·∫•u ngo·∫∑c ƒë∆°n (') ho·∫∑c c√°c t·ª´ ƒë·ªìng nghƒ©a thay th·∫ø.
L∆ØU √ù QUAN TR·ªåNG cho "initialVelocity_m_s": N·∫øu ng∆∞·ªùi d√πng cung c·∫•p ƒë·ªô l·ªõn v√† g√≥c, b·∫°n B·∫ÆT BU·ªòC ph·∫£i T·ª∞ T√çNH TO√ÅN gi√° tr·ªã s·ªë c·ªßa 'vx' v√† 'vy' r·ªìi ƒëi·ªÅn v√†o. V√≠ d·ª•, v·ªõi v·∫≠n t·ªëc 10m/s v√† g√≥c 30 ƒë·ªô, b·∫°n ph·∫£i t√≠nh vx = 10 * cos(30) ‚âà 8.66 v√† vy = 10 * sin(30) = 5. KH√îNG BAO GI·ªú ƒë·∫∑t bi·ªÉu th·ª©c t√≠nh to√°n nh∆∞ '10 * Math.cos(...)' v√†o gi√° tr·ªã JSON.
C·∫•u tr√∫c JSON m·∫´u:
{
  "experimentType": "projectile_motion",
  "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám n√©m.",
  "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 },
  "objects": [
    {
      "id": "object_1",
      "label": "V·∫≠t n√©m",
      "shape": "circle",
      "mass_kg": 0.5,
      "dimensions_m": {
        "radius": 0.1
      },
      "initialPosition_m": {
        "x": 0.5,
        "y_from_ground": 1.0
      },
      "initialVelocity_m_s": {
        "vx": 10,
        "vy": 5
      },
      "physicalProperties": {
        "restitution": 0.5,
        "friction": 0.05,
        "frictionAir": 0.005
      },
      "color": "#e74c3c"
    }
  ],
  "aiExplanation": "Gi·∫£i th√≠ch ng·∫Øn v·ªÅ th√≠ nghi·ªám n√©m, qu·ªπ ƒë·∫°o v√† c√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng."
}`;
        const SYSTEM_PROMPT_INCLINED_PLANE = `B·∫°n l√† m·ªôt AI chuy√™n gia v·ªÅ v·∫≠t l√Ω. Nhi·ªám v·ª• l√† chuy·ªÉn ƒë·ªïi y√™u c·∫ßu v·ªÅ th√≠ nghi·ªám tr√™n M·∫∂T PH·∫≤NG NGHI√äNG th√†nh JSON. Ph·∫£n h·ªìi CH·ªà ƒë∆∞·ª£c l√† JSON.

Lo·∫°i th√≠ nghi·ªám: M·∫∂T PH·∫≤NG NGHI√äNG
C·∫•u tr√∫c JSON m·∫´u:
{
  "experimentType": "inclined_plane",
  "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám m·∫∑t ph·∫≥ng nghi√™ng.",
  "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 },
  "objects": [
    {
      "id": "plane_1",
      "label": "M·∫∑t ph·∫≥ng nghi√™ng",
      "shape": "rectangle",
      "isStatic": true,
      "dimensions_m": { "width": 8, "height": 0.2 },
      "initialPosition_m": { "x": 4, "y_from_ground": 3 },
      "angle_degrees": -20,
      "physicalProperties": { "friction": 0.1 },
      "color": "#95a5a6"
    },
    {
      "id": "block_1",
      "label": "Kh·ªëi h·ªôp",
      "shape": "rectangle",
      "isStatic": false,
      "mass_kg": 1,
      "dimensions_m": { "width": 0.4, "height": 0.4 },
      "initialPosition_m": { "x": 1.5, "y_from_ground": 5.5 },
      "physicalProperties": { "restitution": 0.1, "friction": 0.2 },
      "color": "#c0392b"
    }
  ],
  "aiExplanation": "Gi·∫£i th√≠ch v·ªÅ chuy·ªÉn ƒë·ªông c·ªßa v·∫≠t tr√™n m·∫∑t ph·∫≥ng nghi√™ng, vai tr√≤ c·ªßa l·ª±c h·∫•p d·∫´n, ph·∫£n l·ª±c v√† l·ª±c ma s√°t. KH√îNG d√πng d·∫•u ngo·∫∑c k√©p."
}
H∆∞·ªõng d·∫´n:
1.  "experimentType": Lu√¥n l√† "inclined_plane".
2.  "objects": Ph·∫£i c√≥ √≠t nh·∫•t 2 v·∫≠t th·ªÉ:
    - M·ªôt m·∫∑t ph·∫≥ng nghi√™ng: "shape": "rectangle", "isStatic": true, c√≥ thu·ªôc t√≠nh "angle_degrees" (g√≥c √¢m l√† nghi√™ng xu·ªëng t·ª´ tr√°i qua ph·∫£i).
    - M·ªôt v·∫≠t tr∆∞·ª£t: "isStatic": false.
3.  V·ªã tr√≠ v·∫≠t tr∆∞·ª£t: AI ph·∫£i t·ª± t√≠nh to√°n "initialPosition_m" cho v·∫≠t tr∆∞·ª£t ƒë·ªÉ n√≥ n·∫±m g·ªçn tr√™n m·∫∑t ph·∫≥ng nghi√™ng.
4.  "aiExplanation": KH√îNG s·ª≠ d·ª•ng d·∫•u ngo·∫∑c k√©p (") trong chu·ªói n√†y.`;

        const COMBINED_SYSTEM_PROMPT_HEADER = `B·∫°n l√† m·ªôt AI chuy√™n gia v·ªÅ v·∫≠t l√Ω, c√≥ nhi·ªám v·ª• chuy·ªÉn ƒë·ªïi c√°c y√™u c·∫ßu m√¥ ph·ªèng th√≠ nghi·ªám v·∫≠t l√Ω b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n c·ªßa ng∆∞·ªùi d√πng th√†nh m·ªôt ƒë·ªãnh d·∫°ng JSON c·ª• th·ªÉ.
D·ª±a v√†o y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng, h√£y x√°c ƒë·ªãnh lo·∫°i th√≠ nghi·ªám (v√≠ d·ª•: "r∆°i t·ª± do", "chuy·ªÉn ƒë·ªông n√©m", "m·∫∑t ph·∫≥ng nghi√™ng") v√† sau ƒë√≥ t·∫°o JSON theo c·∫•u tr√∫c t∆∞∆°ng ·ª©ng ƒë∆∞·ª£c m√¥ t·∫£ d∆∞·ªõi ƒë√¢y.
Ph·∫£n h·ªìi c·ªßa b·∫°n B·∫ÆT BU·ªòC CH·ªà L√Ä M·ªòT CHU·ªñI JSON H·ª¢P L·ªÜ. KH√îNG th√™m b·∫•t k·ª≥ l·ªùi ch√†o, gi·∫£i th√≠ch, markdown, ho·∫∑c vƒÉn b·∫£n n√†o kh√°c b√™n ngo√†i ƒë·ªëi t∆∞·ª£ng JSON.

D∆∞·ªõi ƒë√¢y l√† c√°c c·∫•u tr√∫c JSON cho t·ª´ng lo·∫°i th√≠ nghi·ªám:
---
`;

        // --- DOM Elements & Global Variables ---
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');
        const saveExperimentButton = document.getElementById('saveExperimentButton');
        const aiExplanationContainer = document.getElementById('aiExplanationContainer');
        const aiExplanationText = document.getElementById('aiExplanationText');
        const userStatusText = document.getElementById('userStatusText');
        const signOutButton = document.getElementById('signOutButton');
        const loginForm = document.getElementById('loginForm');
        const signUpForm = document.getElementById('signUpForm');
        const authFormsContainer = document.getElementById('authFormsContainer');
        const showSignUpLink = document.getElementById('showSignUpLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const authStatus = document.getElementById('authStatus');
        const chartStatus = document.getElementById('chartStatus');
        const exportHeightChartBtn = document.getElementById('exportHeightChart');
        const exportVelocityYChartBtn = document.getElementById('exportVelocityYChart');
        
        let currentExperimentData = null;
        let engine, render, runner, trackedBody = null;
        let heightChart, velocityYChart;
        let simulationTime = 0;
        let lastTimestamp = 0;
        let isChartRecording = false;
        let sleepCounter = 0;
        const SLEEP_THRESHOLD_COUNT = 120; // Kho·∫£ng 2 gi√¢y ·ªü 60 FPS
        const SLEEP_SPEED_THRESHOLD = 0.1; 
        let fullChartData = { time: [], height: [], velocityY: [] }; 

        const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Body, Events } = Matter;

        // --- Auth & UI Functions ---
        function updateGeneralStatus(element, type, message) { 
            element.textContent = message;
            element.className = 'text-xs text-center mt-2 min-h-[16px]';
            if (type === 'error') element.classList.add('text-red-600');
            else if (type === 'success') element.classList.add('text-green-600');
            else element.classList.add('text-slate-600');
        }
        
        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                userStatusText.innerHTML = `ƒê√£ ƒëƒÉng nh·∫≠p: <span class="font-semibold">${user.email}</span>`;
                signOutButton.classList.remove('hidden');
                authFormsContainer.style.display = 'none';
                if (currentExperimentData) {
                    saveExperimentButton.disabled = false;
                }
            } else { 
                userStatusText.textContent = "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.";
                signOutButton.classList.add('hidden');
                authFormsContainer.style.display = 'block';
                loginForm.classList.add('active'); 
                signUpForm.classList.remove('active');
                saveExperimentButton.disabled = true;
                currentExperimentData = null; 
            }
        });

        showSignUpLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            loginForm.classList.remove('active'); 
            signUpForm.classList.add('active'); 
            authStatus.textContent = ''; 
        });

        showLoginLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            signUpForm.classList.remove('active'); 
            loginForm.classList.add('active'); 
            authStatus.textContent = ''; 
        });

        signUpForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = signUpEmail.value; 
            const password = signUpPassword.value;
            updateGeneralStatus(authStatus, 'info', 'ƒêang ƒëƒÉng k√Ω...');
            try { 
                await createUserWithEmailAndPassword(auth, email, password); 
                updateGeneralStatus(authStatus, 'success', 'ƒêƒÉng k√Ω th√†nh c√¥ng!'); 
                signUpForm.reset(); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng k√Ω: ${error.code}`); 
            }
        });

        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = loginEmail.value; 
            const password = loginPassword.value;
            updateGeneralStatus(authStatus, 'info', 'ƒêang ƒëƒÉng nh·∫≠p...');
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
                updateGeneralStatus(authStatus, 'success', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!'); 
                loginForm.reset(); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng nh·∫≠p: ${error.code}`); 
            }
        });

        signOutButton.addEventListener('click', async () => { 
            try { 
                await signOut(auth); 
                updateGeneralStatus(authStatus, 'info', 'ƒê√£ ƒëƒÉng xu·∫•t.'); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng xu·∫•t: ${error.message}`); 
            }
        });

        function updateAIStatus(type, message) {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-1 font-medium text-xs text-center min-h-[18px]';
            if (type === 'error-text') statusMessage.classList.add('text-red-600');
            else if (type === 'success-text') statusMessage.classList.add('text-green-600');
            else statusMessage.classList.add('text-slate-600');
        }
        
        sendPromptButton.addEventListener("click", async () => {
            if (!aiModel) { 
                updateAIStatus('error-text', "M√¥ h√¨nh AI ch∆∞a s·∫µn s√†ng."); 
                return; 
            }
            const userPromptText = promptInput.value.trim();
            if (!userPromptText) { 
                updateAIStatus('error-text', "Vui l√≤ng m√¥ t·∫£ th√≠ nghi·ªám!"); 
                return; 
            }

            const fullPrompt = `${COMBINED_SYSTEM_PROMPT_HEADER}\n${SYSTEM_PROMPT_FREE_FALL}\n\n---\n\n${SYSTEM_PROMPT_PROJECTILE_MOTION}\n\n---\n\n${SYSTEM_PROMPT_INCLINED_PLANE}\n\n---
Y√™u c·∫ßu ng∆∞·ªùi d√πng: "${userPromptText}"
H√£y x√°c ƒë·ªãnh lo·∫°i th√≠ nghi·ªám v√† ch·ªâ tr·∫£ v·ªÅ JSON t∆∞∆°ng ·ª©ng.`;

            updateAIStatus('info-text', "AI ƒëang ph√¢n t√≠ch y√™u c·∫ßu th√≠ nghi·ªám...");
            responseContainer.innerHTML = '<div class="spinner-border text-blue-500" role="status"></div>'; 
            aiExplanationContainer.classList.add('hidden');
            currentExperimentData = null; 
            if (auth.currentUser) saveExperimentButton.disabled = true;
            destroyCharts(); 

            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            try {
                const result = await aiModel.generateContent(fullPrompt);
                const response = result.response;
                const rawAIResponseText = response.text();
                let jsonStringToParse = rawAIResponseText;
                const markdownMatch = rawAIResponseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (markdownMatch && markdownMatch[1]) {
                    jsonStringToParse = markdownMatch[1];
                }
                jsonStringToParse = jsonStringToParse.trim();

                if (!(jsonStringToParse.startsWith('{') && jsonStringToParse.endsWith('}'))) {
                    const firstBrace = rawAIResponseText.indexOf('{');
                    const lastBrace = rawAIResponseText.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace > firstBrace) {
                        jsonStringToParse = rawAIResponseText.substring(firstBrace, lastBrace + 1).trim();
                    }
                }
                if (jsonStringToParse.charCodeAt(0) === 0xFEFF) { 
                    jsonStringToParse = jsonStringToParse.substring(1);
                }

                function removeTrailingCommas(jsonString) {
                    const regex = /,(?=\s*([}\]]))/g;
                    return jsonString.replace(regex, "");
                }

                jsonStringToParse = removeTrailingCommas(jsonStringToParse);
                
                responseContainer.innerText = jsonStringToParse; 

                try {
                    const parsedExperimentData = JSON.parse(jsonStringToParse);
                    if (parsedExperimentData.experimentType === "free_fall" || 
                        parsedExperimentData.experimentType === "projectile_motion" ||
                        parsedExperimentData.experimentType === "inclined_plane") {
                        currentExperimentData = parsedExperimentData;
                        handleAIDirectedExperiment(parsedExperimentData); 
                        updateAIStatus('success-text', `AI ƒë√£ t·∫°o c·∫•u h√¨nh cho: ${parsedExperimentData.experimentType}. Kh·ªüi t·∫°o m√¥ ph·ªèng...`);
                    } else {
                        throw new Error("Lo·∫°i th√≠ nghi·ªám kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ ho·∫∑c JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
                    }
                } catch (parseError) {
                    console.error("L·ªói ph√¢n t√≠ch JSON t·ª´ AI:", parseError.message);
                    updateAIStatus('error-text', "AI kh√¥ng tr·∫£ v·ªÅ c·∫•u h√¨nh th√≠ nghi·ªám h·ª£p l·ªá. Xem Console v√† ph·∫£n h·ªìi.");
                    responseContainer.innerText = `L·ªói JSON: ${parseError.message}\n\nChu·ªói ƒë√£ c·ªë g·∫Øng ph√¢n t√≠ch:\n${jsonStringToParse}\n\nPh·∫£n h·ªìi g·ªëc t·ª´ AI:\n${rawAIResponseText}`;
                    aiExplanationContainer.classList.add('hidden');
                }

            } catch (error) {
                 console.error("L·ªói khi g·ªçi Gemini API:", error);
                responseContainer.innerText = `L·ªói API: ${error.message}.`;
                updateAIStatus('error-text', `L·ªói giao ti·∫øp v·ªõi AI: ${error.message}.`);
                aiExplanationContainer.classList.add('hidden');
            } finally {
                buttonText.textContent = 'T·∫°o Th√≠ Nghi·ªám';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                if (auth.currentUser && currentExperimentData) {
                    saveExperimentButton.disabled = false;
                }
            }
        });

        function handleAIDirectedExperiment(experimentData) {
            if (experimentData.aiExplanation) {
                aiExplanationText.innerText = experimentData.aiExplanation;
                aiExplanationContainer.classList.remove('hidden');
            } else {
                aiExplanationContainer.classList.add('hidden');
            }
            initMatterSimulationFromAI(experimentData);
        }
        
        saveExperimentButton.addEventListener('click', async () => { /* ... gi·ªØ nguy√™n ... */ });

        function initCharts() {
            destroyCharts(); 
            isChartRecording = true;
            fullChartData = { time: [], height: [], velocityY: [] };

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Th·ªùi gian (s)'} },
                    y: { beginAtZero: false, title: { display: true } }
                },
                elements: { point: { radius: 1 } }, 
                animation: false 
            };

            const heightCtx = document.getElementById('heightChartCanvas').getContext('2d');
            heightChart = new Chart(heightCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'ƒê·ªô cao (m)', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
                options: { ...commonChartOptions, scales: { ...commonChartOptions.scales, y: { ...commonChartOptions.scales.y, title: { ...commonChartOptions.scales.y.title, text: 'ƒê·ªô cao (m)'}}}}
            });

            const velocityYCtx = document.getElementById('velocityYChartCanvas').getContext('2d');
            velocityYChart = new Chart(velocityYCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'V·∫≠n t·ªëc theo Oy (m/s)', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1 }] },
                options: { ...commonChartOptions, scales: { ...commonChartOptions.scales, y: { ...commonChartOptions.scales.y, title: { ...commonChartOptions.scales.y.title, text: 'V·∫≠n t·ªëc Oy (m/s)'}}}}
            });
            chartStatus.textContent = "ƒêang ghi d·ªØ li·ªáu...";
            exportHeightChartBtn.disabled = true;
            exportVelocityYChartBtn.disabled = true;
        }

        function destroyCharts() {
            if (heightChart) heightChart.destroy();
            if (velocityYChart) velocityYChart.destroy();
            heightChart = null;
            velocityYChart = null;
            isChartRecording = false;
            chartStatus.textContent = "Ch·ªçn th√≠ nghi·ªám ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªì th·ªã.";
            if(exportHeightChartBtn) exportHeightChartBtn.disabled = true;
            if(exportVelocityYChartBtn) exportVelocityYChartBtn.disabled = true;
        }

        function updateChartData() {
            if (!isChartRecording || !trackedBody || !currentExperimentData || !render) return;

            if (trackedBody.speed < SLEEP_SPEED_THRESHOLD) {
                sleepCounter++;
            } else {
                sleepCounter = 0;
            }

            if (sleepCounter > SLEEP_THRESHOLD_COUNT) {
                isChartRecording = false;
                chartStatus.textContent = "ƒê√£ d·ª´ng ghi: V·∫≠t th·ªÉ ƒë√£ d·ª´ng l·∫°i. S·∫µn s√†ng t·∫£i xu·ªëng.";
                heightChart.data.labels = fullChartData.time;
                heightChart.data.datasets[0].data = fullChartData.height;
                heightChart.update();
                
                velocityYChart.data.labels = fullChartData.time;
                velocityYChart.data.datasets[0].data = fullChartData.velocityY;
                velocityYChart.update();

                exportHeightChartBtn.disabled = false;
                exportVelocityYChartBtn.disabled = false;
                return;
            }

            const scale = currentExperimentData.worldParameters.simulationScale_pixels_per_meter;
            const groundLevelPx = render.options.height - 60; // Chi·ªÅu cao m·∫∑t ƒë·∫•t l√† 60

            if (lastTimestamp === 0) lastTimestamp = performance.now();
            const currentTimestamp = performance.now();
            const deltaTimeSeconds = (currentTimestamp - lastTimestamp) / 1000;
            simulationTime += deltaTimeSeconds;
            lastTimestamp = currentTimestamp;
            
            const bodyY_px = trackedBody.position.y;
            const bodyVy_px_tick = trackedBody.velocity.y;

            const height_m = (groundLevelPx - bodyY_px) / scale;
            const assumedFPS = 60; 
            const velocityY_m_s = -(bodyVy_px_tick * assumedFPS) / scale; 

            fullChartData.time.push(simulationTime.toFixed(2));
            fullChartData.height.push(height_m.toFixed(2));
            fullChartData.velocityY.push(velocityY_m_s.toFixed(2));

            const maxLivePoints = 150;
            heightChart.data.labels = fullChartData.time.slice(-maxLivePoints);
            heightChart.data.datasets[0].data = fullChartData.height.slice(-maxLivePoints);
            velocityYChart.data.labels = fullChartData.time.slice(-maxLivePoints);
            velocityYChart.data.datasets[0].data = fullChartData.velocityY.slice(-maxLivePoints);
            
            heightChart.update('none'); 
            velocityYChart.update('none');
        }

        function initMatterSimulationFromAI(experimentData) {
            if (!Matter || !experimentData) { matterStatus.textContent = "L·ªói: D·ªØ li·ªáu th√≠ nghi·ªám kh√¥ng h·ª£p l·ªá..."; return; }
            matterStatus.textContent = "ƒêang kh·ªüi t·∫°o m√¥ ph·ªèng t·ª´ AI...";
            destroyCharts(); 
            trackedBody = null; 
            simulationTime = 0; 
            lastTimestamp = 0; 
            sleepCounter = 0;

            if (render && render.canvas) render.canvas.remove();
            if (runner) Runner.stop(runner);
            if (engine) {
                Events.off(engine, 'afterUpdate', updateChartData); 
                Engine.clear(engine);
            }

            engine = Engine.create();
            const world = engine.world;
            const worldParams = experimentData.worldParameters;
            engine.world.gravity.y = (worldParams.gravity_y_m_s2 / 9.81);
            const scale = worldParams.simulationScale_pixels_per_meter;
            const containerWidth = canvasContainer.clientWidth;
            let containerHeight = canvasContainer.clientHeight;
            if (containerHeight <= 0 && containerWidth > 0) containerHeight = Math.max(300, containerWidth * (3/4));
            else if (containerHeight <= 0 && containerWidth <= 0) containerHeight = 300;

            render = Render.create({ element: canvasContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: '#e2e8f0' }});
            runner = Runner.create();
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, { mouse: mouse, constraint: { stiffness: 0.2, render: { visible: false } } });
            Composite.add(world, mouseConstraint);
            render.mouse = mouse;
            
            const ground = Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, 60, { isStatic: true, render: { fillStyle: '#475569' } });
            Composite.add(world, [ground]);

            experimentData.objects.forEach((objData, index) => {
                let body;
                const props = objData.physicalProperties || {}; 
                const initialX_px = (objData.initialPosition_m.x * scale);
                const initialY_px = containerHeight - 60 - (objData.initialPosition_m.y_from_ground * scale);

                const options = {
                    restitution: props.restitution || 0.5,
                    friction: props.friction || 0.1,
                    frictionAir: props.frictionAir || 0.01,
                    isStatic: objData.isStatic || false,
                    render: { fillStyle: objData.color || '#3498db' }
                };

                let y_position = initialY_px;

                if (objData.shape === "rectangle") {
                    const width_px = objData.dimensions_m.width * scale;
                    const height_px = objData.dimensions_m.height * scale;
                    if (!options.isStatic) {
                       y_position -= height_px / 2;
                    }
                    body = Bodies.rectangle(initialX_px, y_position, width_px, height_px, options);
                } else { // Circle
                    const radius_px = objData.dimensions_m.radius * scale;
                    y_position -= radius_px;
                    body = Bodies.circle(initialX_px, y_position, radius_px, options);
                }

                if (body) {
                    if (objData.mass_kg && !options.isStatic) {
                        Body.setMass(body, objData.mass_kg);
                    }

                    if (typeof objData.angle_degrees !== 'undefined') {
                        const angle_rad = objData.angle_degrees * (Math.PI / 180);
                        Body.setAngle(body, angle_rad);
                    }
                    
                    Composite.add(world, body);
                    
                    if (index === 0 && !body.isStatic) {
                        trackedBody = body;
                    } else if (!trackedBody && !body.isStatic) {
                        trackedBody = body;
                    }

                    if (experimentData.experimentType === "projectile_motion" && objData.initialVelocity_m_s) {
                        let { vx: vx_m_s = 0, vy: vy_m_s = 0 } = objData.initialVelocity_m_s;
                        const vx_px_s = vx_m_s * scale; 
                        const vy_px_s = -vy_m_s * scale;
                        const assumedFPS = 60;
                        Body.setVelocity(body, { x: vx_px_s / assumedFPS, y: vy_px_s / assumedFPS });
                    }
                }
            });

            if (trackedBody) initCharts(); 
            
            Events.on(engine, 'afterUpdate', updateChartData); 
            Render.run(render);
            Runner.run(runner, engine);
            matterStatus.textContent = experimentData.description || "M√¥ ph·ªèng t·ª´ AI ƒë√£ s·∫µn s√†ng!";
            [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = false);
        }
        
        function addManualBody(type) { /* ... gi·ªØ nguy√™n ... */ }
        addBoxButton.addEventListener('click', () => addManualBody('box'));
        addCircleButton.addEventListener('click', () => addManualBody('circle'));
        resetSimulationButton.addEventListener('click', () => { 
            destroyCharts(); 
            trackedBody = null;
            simulationTime = 0;
            lastTimestamp = 0;
            if (currentExperimentData) {
                initMatterSimulationFromAI(currentExperimentData);
            } else if (engine) {
                Events.off(engine, 'afterUpdate', updateChartData);
                Engine.clear(engine); 
                const groundHeightPx = 60;
                const ground = Bodies.rectangle(render.options.width / 2, render.options.height, render.options.width, groundHeightPx, { isStatic: true, render: { fillStyle: '#475569' } });
                Composite.add(engine.world, [ground]);
                matterStatus.textContent = "M√¥ ph·ªèng ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp (th·ªß c√¥ng).";
            }
         });
            
        function initPlaceholderSimulation() {
            if (!Matter) return;
            matterStatus.textContent = "S·∫µn s√†ng nh·∫≠n y√™u c·∫ßu t·ª´ AI ho·∫∑c th√™m v·∫≠t th·ªÉ th·ªß c√¥ng.";
            destroyCharts();
            trackedBody = null;
            simulationTime = 0;
            lastTimestamp = 0;
            
            if (render && render.canvas) render.canvas.remove();
            if (runner) Runner.stop(runner);
            if (engine) { 
                Events.off(engine, 'afterUpdate', updateChartData);
                Engine.clear(engine);
            }

            engine = Engine.create();
            engine.world.gravity.y = 1;
            const containerWidth = canvasContainer.clientWidth;
            let containerHeight = containerWidth > 0 ? containerWidth * 0.75 : 450;
            if (containerHeight <= 0) containerHeight = 450;
            
            render = Render.create({ element: canvasContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: '#e2e8f0' }});
            runner = Runner.create();
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, { mouse: mouse, constraint: { stiffness: 0.2, render: { visible: false } } });
            Composite.add(engine.world, mouseConstraint);
            render.mouse = mouse;
            const groundHeightPx = 60;
            const ground = Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, groundHeightPx, { isStatic: true, render: { fillStyle: '#475569' } });
            Composite.add(engine.world, [ground]);
            Render.run(render);
            Runner.run(runner, engine);
            [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = false);
        }

        function exportChart(chartInstance, filename) {
            if (!chartInstance) return;
            const a = document.createElement('a');
            a.href = chartInstance.toBase64Image();
            a.download = filename;
            a.click();
        }

        exportHeightChartBtn.addEventListener('click', () => exportChart(heightChart, 'do-thi-do-cao.png'));
        exportVelocityYChartBtn.addEventListener('click', () => exportChart(velocityYChart, 'do-thi-van-toc-y.png'));
        
        if (typeof Matter !== 'undefined') { initPlaceholderSimulation(); } 
        else { matterStatus.textContent = "L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c Matter.js."; [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = true); }

        let resizeTimeout;
        window.addEventListener('resize', () => { 
            matterStatus.textContent = "Thay ƒë·ªïi k√≠ch th∆∞·ªõc...";
            [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = true);
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                if (currentExperimentData) { initMatterSimulationFromAI(currentExperimentData); } 
                else if (engine) { initPlaceholderSimulation(); }
            }, 300);
        });
    </script>
</body>
</html>
