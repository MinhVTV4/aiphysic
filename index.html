<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic & Matter.js - Th√≠ Nghi·ªám V·∫≠t L√Ω AI (B·∫£n ·ªîn ƒê·ªãnh)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style type="text/tailwindcss">
        .spinner-border { display: inline-block; width: 2rem; height: 2rem; vertical-align: text-bottom; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; -webkit-animation: spinner-border .75s linear infinite; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .spinner-sm { width: 1rem; height: 1rem; border-width: .2em; }
        .auth-form { display: none; } 
        .auth-form.active { display: block; }
        .structured-form { display: none; }
        .structured-form.active { display: block; }
        #aiExplanationContainer {
            background-color: #eef2ff;
            border-left: 4px solid #6366f1;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: #4338ca;
        }
        #chartsSection {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        .export-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 119, 255, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10;
        }
        .export-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        #savedExperimentsModal {
            transition: opacity 0.3s ease;
        }
        #experimentsList li {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        #experimentsList li:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-3 sm:p-4 selection:bg-blue-200">
    <header class="w-full max-w-6xl mb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-600 py-2">
            Ph√≤ng Th√≠ Nghi·ªám V·∫≠t L√Ω AI
        </h1>
    </header>

    <section id="authSection" class="w-full max-w-md bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-semibold text-sky-700">T√†i Kho·∫£n Ng∆∞·ªùi D√πng</h2>
            <button id="showSavedExperimentsBtn" class="hidden text-xs bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-md transition-colors">
                Th√≠ nghi·ªám ƒë√£ l∆∞u
            </button>
        </div>
        <div id="userStatusContainer" class="text-center text-sm mb-3">
            <p id="userStatusText">ƒêang t·∫£i tr·∫°ng th√°i ng∆∞·ªùi d√πng...</p>
            <button id="signOutButton" class="hidden mt-1 text-xs bg-rose-500 hover:bg-rose-600 text-white py-1 px-3 rounded-md transition-colors">ƒêƒÉng Xu·∫•t</button>
        </div>
        <div id="authFormsContainer">
            <form id="loginForm" class="auth-form space-y-3 p-3 bg-slate-50 rounded-lg">
                <h3 class="text-md font-medium text-slate-700">ƒêƒÉng Nh·∫≠p</h3>
                <div><label for="loginEmail" class="block text-xs font-medium text-slate-600">Email</label><input type="email" id="loginEmail" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <div><label for="loginPassword" class="block text-xs font-medium text-slate-600">M·∫≠t kh·∫©u</label><input type="password" id="loginPassword" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <button type="submit" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">ƒêƒÉng Nh·∫≠p</button>
                <p class="text-xs text-center">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="showSignUpLink" class="text-blue-600 hover:underline">ƒêƒÉng k√Ω</a></p>
            </form>
            <form id="signUpForm" class="auth-form space-y-3 p-3 bg-slate-50 rounded-lg">
                <h3 class="text-md font-medium text-slate-700">ƒêƒÉng K√Ω</h3>
                <div><label for="signUpEmail" class="block text-xs font-medium text-slate-600">Email</label><input type="email" id="signUpEmail" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <div><label for="signUpPassword" class="block text-xs font-medium text-slate-600">M·∫≠t kh·∫©u</label><input type="password" id="signUpPassword" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2"></div>
                <button type="submit" class="w-full text-sm bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">ƒêƒÉng K√Ω</button>
                <p class="text-xs text-center">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="showLoginLink" class="text-green-600 hover:underline">ƒêƒÉng nh·∫≠p</a></p>
            </form>
            <p id="authStatus" class="text-xs text-center mt-2 min-h-[16px]"></p>
        </div>
    </section>

    <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6 px-2 flex-grow">
        <div class="lg:col-span-1 lg:h-[calc(100vh-22rem)] lg:overflow-y-auto pr-2">
            <section id="aiControlsSection" class="bg-white p-5 rounded-xl shadow-xl flex flex-col">
                <h2 class="text-xl font-semibold text-center mb-1 text-blue-700"><span role="img" aria-label="robot" class="mr-2">ü§ñ</span>ƒêi·ªÅu Khi·ªÉn AI</h2>
                <p class="text-center text-xs text-slate-500 mb-4">(Model: gemini-1.5-flash-latest)</p>
                
                <div class="border-t border-slate-200 pt-4">
                    <h3 class="text-md font-semibold text-center mb-3 text-slate-700">T·∫°o th√≠ nghi·ªám theo m·∫´u</h3>
                    <select id="experimentTypeSelect" class="w-full p-2 border border-slate-300 rounded-md text-sm">
                        <option value="">-- Ch·ªçn lo·∫°i th√≠ nghi·ªám --</option>
                        <option value="free_fall">R∆°i t·ª± do</option>
                        <option value="projectile">N√©m xi√™n / N√©m ngang</option>
                        <option value="incline">M·∫∑t ph·∫≥ng nghi√™ng</option>
                        <option value="collision">Va ch·∫°m</option>
                    </select>

                    <form id="formFreeFall" class="structured-form mt-3 space-y-2 p-3 bg-slate-50 rounded-lg">
                        <div><label class="block text-xs font-medium text-slate-600">Kh·ªëi l∆∞·ª£ng v·∫≠t (kg)</label><input type="number" id="ff_mass" value="1" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">ƒê·ªô cao th·∫£ (m)</label><input type="number" id="ff_height" value="10" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                    </form>

                    <form id="formProjectile" class="structured-form mt-3 space-y-2 p-3 bg-slate-50 rounded-lg">
                        <div><label class="block text-xs font-medium text-slate-600">Kh·ªëi l∆∞·ª£ng v·∫≠t (kg)</label><input type="number" id="p_mass" value="1" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">V·∫≠n t·ªëc ban ƒë·∫ßu (m/s)</label><input type="number" id="p_velocity" value="15" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">G√≥c b·∫Øn (ƒë·ªô)</label><input type="number" id="p_angle" value="30" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">ƒê·ªô cao ban ƒë·∫ßu (m)</label><input type="number" id="p_height" value="0" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                    </form>

                    <form id="formIncline" class="structured-form mt-3 space-y-2 p-3 bg-slate-50 rounded-lg">
                        <div><label class="block text-xs font-medium text-slate-600">G√≥c nghi√™ng (ƒë·ªô)</label><input type="number" id="i_angle" value="25" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">Kh·ªëi l∆∞·ª£ng v·∫≠t (kg)</label><input type="number" id="i_mass" value="1" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div><label class="block text-xs font-medium text-slate-600">H·ªá s·ªë ma s√°t</label><input type="number" id="i_friction" value="0.1" step="0.05" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                    </form>

                    <form id="formCollision" class="structured-form mt-3 space-y-2 p-3 bg-slate-50 rounded-lg">
                        <p class="text-sm font-semibold text-slate-800">V·∫≠t 1</p>
                        <div><label class="block text-xs font-medium text-slate-600">Kh·ªëi l∆∞·ª£ng (kg)</label><input type="number" id="c1_mass" value="2" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-medium text-slate-600">V·∫≠n t·ªëc Ox (m/s)</label><input type="number" id="c1_vx" value="5" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                            <div><label class="block text-xs font-medium text-slate-600">V·∫≠n t·ªëc Oy (m/s)</label><input type="number" id="c1_vy" value="0" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        </div>
                        <p class="text-sm font-semibold text-slate-800 pt-2 border-t mt-2">V·∫≠t 2</p>
                        <div><label class="block text-xs font-medium text-slate-600">Kh·ªëi l∆∞·ª£ng (kg)</label><input type="number" id="c2_mass" value="2" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-medium text-slate-600">V·∫≠n t·ªëc Ox (m/s)</label><input type="number" id="c2_vx" value="-5" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                            <div><label class="block text-xs font-medium text-slate-600">V·∫≠n t·ªëc Oy (m/s)</label><input type="number" id="c2_vy" value="0" class="w-full mt-1 p-1.5 text-sm rounded-md"></div>
                        </div>
                         <div class="pt-2"><label class="flex items-center text-xs font-medium text-slate-600"><input type="checkbox" id="c_elastic" class="rounded mr-2">Va ch·∫°m ƒë√†n h·ªìi (n·∫£y ra)</label></div>
                    </form>

                    <button id="generatePromptFromFormBtn" class="mt-3 w-full bg-slate-600 text-white py-2 rounded-md hover:bg-slate-700 text-sm">T·∫°o M√¥ T·∫£ & ƒêi·ªÅn V√†o √î D∆∞·ªõi</button>
                </div>
                
                <div class="my-4 flex items-center"><div class="flex-grow border-t border-slate-300"></div><span class="px-2 text-sm text-slate-500">Ho·∫∑c</span><div class="flex-grow border-t border-slate-300"></div></div>

                <textarea id="promptInput" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y text-sm shadow-sm mb-3" placeholder="M√¥ t·∫£ th√≠ nghi·ªám b·∫±ng vƒÉn b·∫£n t·ª± do..."></textarea>
                
                <div class="flex space-x-2 mb-3">
                    <button id="sendPromptButton" class="flex-grow py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all duration-150 ease-in-out text-sm">
                        <span id="buttonText">T·∫°o Th√≠ Nghi·ªám</span>
                        <div id="buttonSpinner" class="spinner-sm spinner-border hidden" role="status"></div>
                    </button>
                    <button id="saveExperimentButton" title="L∆∞u c·∫•u h√¨nh th√≠ nghi·ªám hi·ªán t·∫°i (JSON t·ª´ AI)" class="py-2.5 px-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors text-sm" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7.5 2.813A2.5 2.5 0 005 5.237V14.763a2.5 2.5 0 002.5 2.424l8-1.23A2.5 2.5 0 0018 13.537V4.463a2.5 2.5 0 00-2.5-2.424l-8-1.23zM16.5 4.463v9.074l-8 1.23V5.693l8-1.23z"/><path d="M5 16.187A1 1 0 014 15.187V4.813a1 1 0 011.5-.866l8 1.231a1 1 0 01.5.866v9.074a1 1 0 01-1.5.866l-8-1.231zM6 5.877v8.246l7 .923V6.8l-7-.923z" clip-rule="evenodd" fill-rule="evenodd"/></svg>
                    </button>
                </div>
                <p id="statusMessage" class="mt-1 font-medium text-xs text-center text-slate-600 min-h-[18px]"></p>
                <div id="responseContainer" class="p-3 border border-slate-200 bg-slate-50 rounded-lg whitespace-pre-wrap break-words text-xs text-slate-700 shadow-inner relative flex items-center justify-center transition-colors min-h-[60px] max-h-40 overflow-y-auto">Ph·∫£n h·ªìi c·ªßa AI s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
                <div id="aiExplanationContainer" class="hidden"><h4 class="font-semibold text-sm mb-1">Gi·∫£i th√≠ch t·ª´ AI:</h4><p id="aiExplanationText" class="text-xs"></p></div>
            </section>
        </div>

        <section id="matterJsSection" class="bg-white p-5 rounded-xl shadow-xl lg:col-span-2 flex flex-col">
            <h2 class="text-xl font-semibold text-center mb-2 text-blue-700"><span role="img" aria-label="atom" class="mr-2">‚öõÔ∏è</span>Kh√¥ng Gian Th√≠ Nghi·ªám</h2>
            <div id="canvasContainer" class="w-full bg-slate-200 rounded-lg shadow-inner overflow-hidden mx-auto flex-grow"></div>
            <p id="matterStatus" class="text-center text-xs text-slate-500 mt-2 min-h-[18px]">ƒêang t·∫£i Matter.js...</p>
            <div class="mt-3 grid grid-cols-4 gap-2">
                <button id="addBoxButton" class="py-2 px-2 bg-sky-500 text-white font-medium rounded-md hover:bg-sky-600 transition-colors text-xs shadow disabled:bg-sky-300">Th√™m H·ªôp</button>
                <button id="addCircleButton" class="py-2 px-2 bg-teal-500 text-white font-medium rounded-md hover:bg-teal-600 transition-colors text-xs shadow disabled:bg-teal-300">Th√™m Tr√≤n</button>
                <button id="pauseResumeButton" class="py-2 px-2 bg-amber-500 text-white font-medium rounded-md hover:bg-amber-600 transition-colors text-xs shadow disabled:bg-amber-300" disabled>T·∫°m D·ª´ng</button>
                <button id="resetSimulationButton" class="py-2 px-2 bg-rose-500 text-white font-medium rounded-md hover:bg-rose-600 transition-colors text-xs shadow disabled:bg-rose-300">Reset</button>
            </div>
            
            <div id="chartsSection" class="mt-6 p-4 bg-white rounded-xl shadow-lg">
                <h3 class="text-md font-semibold text-center text-sky-700 mb-3">ƒê·ªì Th·ªã D·ªØ Li·ªáu</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="chart-container">
                        <canvas id="velocityXChartCanvas"></canvas>
                        <button id="exportVelocityXChart" class="export-btn" disabled>T·∫£i xu·ªëng</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="velocityYChartCanvas"></canvas>
                        <button id="exportVelocityYChart" class="export-btn" disabled>T·∫£i xu·ªëng</button>
                    </div>
                </div>
                 <p id="chartStatus" class="text-center text-xs text-slate-500 mt-2 min-h-[18px]">Ch·ªçn th√≠ nghi·ªám ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªì th·ªã.</p>
            </div>
        </section>
    </main>

    <!-- Modal cho Th√≠ nghi·ªám ƒë√£ l∆∞u -->
    <div id="savedExperimentsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-sky-700">Th√≠ Nghi·ªám C·ªßa B·∫°n</h3>
                <button id="closeModalBtn" class="text-2xl font-bold hover:text-red-500 transition-colors">&times;</button>
            </div>
            <div id="experimentsListContainer" class="max-h-80 overflow-y-auto">
                <ul id="experimentsList">
                    <!-- C√°c th√≠ nghi·ªám ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                </ul>
            </div>
        </div>
    </div>
    
    <footer class="w-full max-w-6xl mt-8 mb-4 text-center text-xs text-slate-500">
        <p>&copy; 2024 - Ph√≤ng th√≠ nghi·ªám V·∫≠t l√Ω AI.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMNnx2yS-yeH_N7m_pCaVInqV2RZG7HSY",
            authDomain: "aiphysic.firebaseapp.com",
            projectId: "aiphysic",
            storageBucket: "aiphysic.appspot.com",
            messagingSenderId: "922235658911",
            appId: "1:922235658911:web:5dc24f88c82667e0e478aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
        } catch(e) {
            console.error("Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase AI.", e);
        }

        const VALID_EXPERIMENT_TYPES = ["free_fall", "projectile_motion", "inclined_plane", "collision"];
        const COMBINED_SYSTEM_PROMPT_HEADER = `B·∫°n l√† m·ªôt AI chuy√™n gia v·ªÅ v·∫≠t l√Ω, c√≥ nhi·ªám v·ª• chuy·ªÉn ƒë·ªïi c√°c y√™u c·∫ßu m√¥ ph·ªèng th√≠ nghi·ªám v·∫≠t l√Ω b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n c·ªßa ng∆∞·ªùi d√πng th√†nh m·ªôt ƒë·ªãnh d·∫°ng JSON c·ª• th·ªÉ.
QUAN TR·ªåNG NH·∫§T: Tr∆∞·ªùng "experimentType" B·∫ÆT BU·ªòC ph·∫£i l√† m·ªôt trong c√°c gi√° tr·ªã sau: ${JSON.stringify(VALID_EXPERIMENT_TYPES)}. KH√îNG ƒë∆∞·ª£c s·ª≠ d·ª•ng b·∫•t k·ª≥ gi√° tr·ªã n√†o kh√°c.
Ph·∫£n h·ªìi c·ªßa b·∫°n B·∫ÆT BU·ªòC CH·ªà L√Ä M·ªòT CHU·ªñI JSON H·ª¢P L·ªÜ. KH√îNG th√™m b·∫•t k·ª≥ l·ªùi ch√†o, gi·∫£i th√≠ch, markdown, ho·∫∑c vƒÉn b·∫£n n√†o kh√°c b√™n ngo√†i ƒë·ªëi t∆∞·ª£ng JSON.

D∆∞·ªõi ƒë√¢y l√† c√°c c·∫•u tr√∫c JSON cho t·ª´ng lo·∫°i th√≠ nghi·ªám:
---
`;
        const SYSTEM_PROMPT_FREE_FALL = `Lo·∫°i th√≠ nghi·ªám: R∆†I T·ª∞ DO ("experimentType": "free_fall")
L∆ØU √ù QUAN TR·ªåNG cho "aiExplanation": KH√îNG s·ª≠ d·ª•ng d·∫•u ngo·∫∑c k√©p (") b√™n trong chu·ªói gi·∫£i th√≠ch.
C·∫•u tr√∫c JSON m·∫´u:
{ "experimentType": "free_fall", "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám.", "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 }, "objects": [ { "id": "object_1", "label": "T√™n v·∫≠t", "shape": "circle", "mass_kg": 0.5, "dimensions_m": { "radius": 0.1 }, "initialPosition_m": { "x": 2.5, "y_from_ground": 10 }, "physicalProperties": { "restitution": 0.6, "friction": 0.1, "frictionAir": 0.01 }, "color": "#3498db" } ], "aiExplanation": "Gi·∫£i th√≠ch ng·∫Øn v·ªÅ th√≠ nghi·ªám v√† c√°c th√¥ng s·ªë." }`;
        const SYSTEM_PROMPT_PROJECTILE_MOTION = `Lo·∫°i th√≠ nghi·ªám: CHUY·ªÇN ƒê·ªòNG N√âM ("experimentType": "projectile_motion")
L∆ØU √ù QUAN TR·ªåNG cho "initialVelocity_m_s": N·∫øu ng∆∞·ªùi d√πng cung c·∫•p ƒë·ªô l·ªõn v√† g√≥c, b·∫°n B·∫ÆT BU·ªòC ph·∫£i T·ª∞ T√çNH TO√ÅN gi√° tr·ªã s·ªë c·ªßa 'vx' v√† 'vy' r·ªìi ƒëi·ªÅn v√†o. V√≠ d·ª•, v·ªõi v·∫≠n t·ªëc 10m/s v√† g√≥c 30 ƒë·ªô, b·∫°n ph·∫£i t√≠nh vx = 10 * cos(30) ‚âà 8.66 v√† vy = 10 * sin(30) = 5. KH√îNG BAO GI·ªú ƒë·∫∑t bi·ªÉu th·ª©c t√≠nh to√°n v√†o gi√° tr·ªã JSON.
C·∫•u tr√∫c JSON m·∫´u:
{ "experimentType": "projectile_motion", "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám n√©m.", "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 }, "objects": [ { "id": "object_1", "label": "V·∫≠t n√©m", "shape": "circle", "mass_kg": 0.5, "dimensions_m": { "radius": 0.1 }, "initialPosition_m": { "x": 0.5, "y_from_ground": 1.0 }, "initialVelocity_m_s": { "vx": 10, "vy": 5 }, "physicalProperties": { "restitution": 0.5, "friction": 0.05, "frictionAir": 0.005 }, "color": "#e74c3c" } ], "aiExplanation": "Gi·∫£i th√≠ch ng·∫Øn v·ªÅ th√≠ nghi·ªám n√©m, qu·ªπ ƒë·∫°o v√† c√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng." }`;
        const SYSTEM_PROMPT_INCLINED_PLANE = `Lo·∫°i th√≠ nghi·ªám: M·∫∂T PH·∫≤NG NGHI√äNG ("experimentType": "inclined_plane")
H∆∞·ªõng d·∫´n v·ªã tr√≠: V·ªõi m·∫∑t ph·∫≥ng nghi√™ng xu·ªëng sang ph·∫£i (g√≥c √¢m), t√¢m c·ªßa n√≥ (initialPosition_m.x) n√™n ·ªü b√™n tr√°i (v√≠ d·ª• x=3). V·ªõi m·∫∑t ph·∫≥ng nghi√™ng xu·ªëng sang tr√°i (g√≥c d∆∞∆°ng), t√¢m c·ªßa n√≥ n√™n ·ªü b√™n ph·∫£i (v√≠ d·ª• x=7). V·∫≠t tr∆∞·ª£t ph·∫£i ƒë∆∞·ª£c ƒë·∫∑t ·ªü v·ªã tr√≠ cao h∆°n tr√™n m·∫∑t ph·∫≥ng ƒë√≥.
C·∫•u tr√∫c JSON m·∫´u:
{ "experimentType": "inclined_plane", "description": "M√¥ t·∫£ ng·∫Øn v·ªÅ th√≠ nghi·ªám m·∫∑t ph·∫≥ng nghi√™ng.", "worldParameters": { "gravity_y_m_s2": 9.81, "simulationScale_pixels_per_meter": 50 }, "objects": [ { "id": "plane_1", "label": "M·∫∑t ph·∫≥ng nghi√™ng", "shape": "rectangle", "isStatic": true, "dimensions_m": { "width": 8, "height": 0.2 }, "initialPosition_m": { "x": 3, "y_from_ground": 3 }, "angle_degrees": -20, "physicalProperties": { "friction": 0.1 }, "color": "#95a5a6" }, { "id": "block_1", "label": "Kh·ªëi h·ªôp", "shape": "rectangle", "isStatic": false, "mass_kg": 1, "dimensions_m": { "width": 0.4, "height": 0.4 }, "initialPosition_m": { "x": 1.5, "y_from_ground": 5 }, "physicalProperties": { "restitution": 0.1, "friction": 0.2 }, "color": "#c0392b" } ], "aiExplanation": "Gi·∫£i th√≠ch v·ªÅ chuy·ªÉn ƒë·ªông c·ªßa v·∫≠t tr√™n m·∫∑t ph·∫≥ng nghi√™ng. KH√îNG d√πng d·∫•u ngo·∫∑c k√©p." }`;
        const SYSTEM_PROMPT_COLLISION = `Lo·∫°i th√≠ nghi·ªám: VA CH·∫†M ("experimentType": "collision")
H∆∞·ªõng d·∫´n: Th∆∞·ªùng c√≥ hai v·∫≠t th·ªÉ ƒë·ªông. AI c·∫ßn t√≠nh to√°n v·ªã tr√≠ ban ƒë·∫ßu (initialPosition_m) v√† v·∫≠n t·ªëc ban ƒë·∫ßu (initialVelocity_m_s) cho m·ªói v·∫≠t ƒë·ªÉ ch√∫ng va ch·∫°m v√†o nhau ·ªü gi·ªØa kh√¥ng gian. V·ªõi va ch·∫°m ƒë√†n h·ªìi, 'restitution' n√™n l√† 1. V·ªõi va ch·∫°m m·ªÅm, 'restitution' n√™n l√† 0.
C·∫•u tr√∫c JSON m·∫´u:
{ "experimentType": "collision", "description": "M√¥ ph·ªèng va ch·∫°m ƒë√†n h·ªìi gi·ªØa hai v·∫≠t.", "worldParameters": { "gravity_y_m_s2": 0, "simulationScale_pixels_per_meter": 50 }, "objects": [ { "id": "object_1", "label": "V·∫≠t 1", "shape": "circle", "mass_kg": 2, "dimensions_m": { "radius": 0.2 }, "initialPosition_m": { "x": 1, "y_from_ground": 5 }, "initialVelocity_m_s": { "vx": 5, "vy": 0 }, "physicalProperties": { "restitution": 1, "friction": 0, "frictionAir": 0 }, "color": "#2980b9" }, { "id": "object_2", "label": "V·∫≠t 2", "shape": "circle", "mass_kg": 2, "dimensions_m": { "radius": 0.2 }, "initialPosition_m": { "x": 9, "y_from_ground": 5 }, "initialVelocity_m_s": { "vx": -5, "vy": 0 }, "physicalProperties": { "restitution": 1, "friction": 0, "frictionAir": 0 }, "color": "#c0392b" } ], "aiExplanation": "Ph√¢n t√≠ch va ch·∫°m ƒë√†n h·ªìi gi·ªØa hai v·∫≠t, b·∫£o to√†n ƒë·ªông l∆∞·ª£ng v√† nƒÉng l∆∞·ª£ng." }`;

        // --- DOM Elements & Global Variables ---
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');
        const saveExperimentButton = document.getElementById('saveExperimentButton');
        const aiExplanationContainer = document.getElementById('aiExplanationContainer');
        const aiExplanationText = document.getElementById('aiExplanationText');
        const userStatusText = document.getElementById('userStatusText');
        const signOutButton = document.getElementById('signOutButton');
        const loginForm = document.getElementById('loginForm');
        const signUpForm = document.getElementById('signUpForm');
        const authFormsContainer = document.getElementById('authFormsContainer');
        const showSignUpLink = document.getElementById('showSignUpLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const authStatus = document.getElementById('authStatus');
        const showSavedExperimentsBtn = document.getElementById('showSavedExperimentsBtn');
        const savedExperimentsModal = document.getElementById('savedExperimentsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const experimentsList = document.getElementById('experimentsList');
        const chartStatus = document.getElementById('chartStatus');
        const velocityXChartCanvas = document.getElementById('velocityXChartCanvas');
        const velocityYChartCanvas = document.getElementById('velocityYChartCanvas');
        const exportVelocityXChartBtn = document.getElementById('exportVelocityXChart');
        const exportVelocityYChartBtn = document.getElementById('exportVelocityYChart');
        const experimentTypeSelect = document.getElementById('experimentTypeSelect');
        const formFreeFall = document.getElementById('formFreeFall');
        const formProjectile = document.getElementById('formProjectile');
        const formIncline = document.getElementById('formIncline');
        const formCollision = document.getElementById('formCollision');
        const generatePromptFromFormBtn = document.getElementById('generatePromptFromFormBtn');
        const pauseResumeButton = document.getElementById('pauseResumeButton');

        let currentExperimentData = null;
        let engine, render, runner;
        let trackedBodies = [];
        let velocityXChart, velocityYChart;
        let simulationTime = 0;
        let lastTimestamp = 0;
        let isChartRecording = false;
        let isPaused = false;
        let sleepCounter = 0;
        const SLEEP_THRESHOLD_COUNT = 120;
        const SLEEP_SPEED_THRESHOLD = 0.1; 
        let fullChartData = { time: [], velocityX: [], velocityY: [] }; 
        const chartColors = ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)', 'rgb(75, 192, 192)'];

        const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Body, Events } = Matter;

        // --- Auth & UI Functions ---
        function updateGeneralStatus(element, type, message) { 
            element.textContent = message;
            element.className = 'text-xs text-center mt-2 min-h-[16px]';
            if (type === 'error') element.classList.add('text-red-600');
            else if (type === 'success') element.classList.add('text-green-600');
            else element.classList.add('text-slate-600');
        }
        
        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                userStatusText.innerHTML = `ƒê√£ ƒëƒÉng nh·∫≠p: <span class="font-semibold">${user.email}</span>`;
                signOutButton.classList.remove('hidden');
                showSavedExperimentsBtn.classList.remove('hidden');
                authFormsContainer.style.display = 'none';
                if (currentExperimentData) {
                    saveExperimentButton.disabled = false;
                }
            } else { 
                userStatusText.textContent = "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.";
                signOutButton.classList.add('hidden');
                showSavedExperimentsBtn.classList.add('hidden');
                authFormsContainer.style.display = 'block';
                loginForm.classList.add('active'); 
                signUpForm.classList.remove('active');
                saveExperimentButton.disabled = true;
                currentExperimentData = null; 
            }
        });

        showSignUpLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            loginForm.classList.remove('active'); 
            signUpForm.classList.add('active'); 
            authStatus.textContent = ''; 
        });

        showLoginLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            signUpForm.classList.remove('active'); 
            loginForm.classList.add('active'); 
            authStatus.textContent = ''; 
        });

        signUpForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = signUpEmail.value; 
            const password = signUpPassword.value;
            updateGeneralStatus(authStatus, 'info', 'ƒêang ƒëƒÉng k√Ω...');
            try { 
                await createUserWithEmailAndPassword(auth, email, password); 
                updateGeneralStatus(authStatus, 'success', 'ƒêƒÉng k√Ω th√†nh c√¥ng!'); 
                signUpForm.reset(); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng k√Ω: ${error.code}`); 
            }
        });

        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = loginEmail.value; 
            const password = loginPassword.value;
            updateGeneralStatus(authStatus, 'info', 'ƒêang ƒëƒÉng nh·∫≠p...');
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
                updateGeneralStatus(authStatus, 'success', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!'); 
                loginForm.reset(); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng nh·∫≠p: ${error.code}`); 
            }
        });

        signOutButton.addEventListener('click', async () => { 
            try { 
                await signOut(auth); 
                updateGeneralStatus(authStatus, 'info', 'ƒê√£ ƒëƒÉng xu·∫•t.'); 
            } catch (error) { 
                updateGeneralStatus(authStatus, 'error', `L·ªói ƒëƒÉng xu·∫•t: ${error.message}`); 
            }
        });
        
        // --- Saved Experiments Modal Logic ---
        showSavedExperimentsBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem c√°c th√≠ nghi·ªám ƒë√£ l∆∞u.");
                return;
            }
            
            experimentsList.innerHTML = '<li class="text-center text-slate-500">ƒêang t·∫£i...</li>';
            savedExperimentsModal.classList.remove('hidden');
            savedExperimentsModal.classList.add('flex');
            
            try {
                const q = query(collection(db, "userExperiments"), where("userId", "==", user.uid));
                const querySnapshot = await getDocs(q);
                
                let experiments = [];
                querySnapshot.forEach((doc) => {
                    experiments.push(doc.data());
                });

                experiments.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                experimentsList.innerHTML = ''; 
                
                if (experiments.length === 0) {
                    experimentsList.innerHTML = '<li class="text-center text-slate-500">B·∫°n ch∆∞a l∆∞u th√≠ nghi·ªám n√†o.</li>';
                    return;
                }
                
                experiments.forEach((experiment) => {
                    const li = document.createElement('li');
                    li.textContent = experiment.userInput || `Th√≠ nghi·ªám l∆∞u l√∫c ${new Date(experiment.createdAt.seconds * 1000).toLocaleString()}`;
                    li.dataset.experimentData = JSON.stringify(experiment);
                    li.addEventListener('click', () => {
                        const data = JSON.parse(li.dataset.experimentData);
                        promptInput.value = data.userInput;
                        currentExperimentData = data.experimentConfig;
                        handleAIDirectedExperiment(data.experimentConfig);
                        savedExperimentsModal.classList.add('hidden');
                        savedExperimentsModal.classList.remove('flex');
                    });
                    experimentsList.appendChild(li);
                });

            } catch (error) {
                console.error("L·ªói khi t·∫£i th√≠ nghi·ªám ƒë√£ l∆∞u:", error);
                experimentsList.innerHTML = `<li class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i danh s√°ch. L·ªói: ${error.message}</li>`;
            }
        });

        closeModalBtn.addEventListener('click', () => {
            savedExperimentsModal.classList.add('hidden');
            savedExperimentsModal.classList.remove('flex');
        });

        function updateAIStatus(type, message) {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-1 font-medium text-xs text-center min-h-[18px]';
            if (type === 'error-text') statusMessage.classList.add('text-red-600');
            else if (type === 'success-text') statusMessage.classList.add('text-green-600');
            else statusMessage.classList.add('text-slate-600');
        }
        
        sendPromptButton.addEventListener("click", async () => {
            if (!aiModel) { 
                updateAIStatus('error-text', "Kh√¥ng th·ªÉ kh·ªüi t·∫°o m√¥ h√¨nh AI."); 
                return; 
            }

            const userPromptText = promptInput.value.trim();
            if (!userPromptText) { 
                updateAIStatus('error-text', "Vui l√≤ng m√¥ t·∫£ th√≠ nghi·ªám!"); 
                return; 
            }

            const fullPrompt = `${COMBINED_SYSTEM_PROMPT_HEADER}\n${SYSTEM_PROMPT_FREE_FALL}\n\n---\n\n${SYSTEM_PROMPT_PROJECTILE_MOTION}\n\n---\n\n${SYSTEM_PROMPT_INCLINED_PLANE}\n\n---\n\n${SYSTEM_PROMPT_COLLISION}\n\n---
Y√™u c·∫ßu ng∆∞·ªùi d√πng: "${userPromptText}"
H√£y x√°c ƒë·ªãnh lo·∫°i th√≠ nghi·ªám v√† ch·ªâ tr·∫£ v·ªÅ JSON t∆∞∆°ng ·ª©ng.`;

            updateAIStatus('info-text', "AI ƒëang ph√¢n t√≠ch y√™u c·∫ßu th√≠ nghi·ªám...");
            responseContainer.innerHTML = '<div class="spinner-border text-blue-500" role="status"></div>'; 
            aiExplanationContainer.classList.add('hidden');
            currentExperimentData = null; 
            if (auth.currentUser) saveExperimentButton.disabled = true;
            destroyCharts(); 

            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            try {
                const result = await aiModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: fullPrompt }] }]
                }, { signal: controller.signal });
                
                clearTimeout(timeoutId);

                const response = result.response;
                const rawAIResponseText = response.text();
                let jsonStringToParse = rawAIResponseText;
                const markdownMatch = rawAIResponseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (markdownMatch && markdownMatch[1]) {
                    jsonStringToParse = markdownMatch[1];
                }
                jsonStringToParse = jsonStringToParse.trim();

                if (!(jsonStringToParse.startsWith('{') && jsonStringToParse.endsWith('}'))) {
                    const firstBrace = rawAIResponseText.indexOf('{');
                    const lastBrace = rawAIResponseText.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace > firstBrace) {
                        jsonStringToParse = rawAIResponseText.substring(firstBrace, lastBrace + 1).trim();
                    }
                }
                if (jsonStringToParse.charCodeAt(0) === 0xFEFF) { 
                    jsonStringToParse = jsonStringToParse.substring(1);
                }

                function removeTrailingCommas(jsonString) {
                    const regex = /,(?=\s*([}\]]))/g;
                    return jsonString.replace(regex, "");
                }

                jsonStringToParse = removeTrailingCommas(jsonStringToParse);
                
                responseContainer.innerText = jsonStringToParse; 

                try {
                    const parsedExperimentData = JSON.parse(jsonStringToParse);
                    if (parsedExperimentData.experimentType && VALID_EXPERIMENT_TYPES.includes(parsedExperimentData.experimentType)) {
                        currentExperimentData = parsedExperimentData;
                        handleAIDirectedExperiment(parsedExperimentData); 
                        updateAIStatus('success-text', `AI ƒë√£ t·∫°o c·∫•u h√¨nh cho: ${parsedExperimentData.experimentType}. Kh·ªüi t·∫°o m√¥ ph·ªèng...`);
                    } else {
                        throw new Error("Lo·∫°i th√≠ nghi·ªám kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ ho·∫∑c JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
                    }
                } catch (parseError) {
                    console.error("L·ªói ph√¢n t√≠ch JSON t·ª´ AI:", parseError.message);
                    updateAIStatus('error-text', "AI kh√¥ng tr·∫£ v·ªÅ c·∫•u h√¨nh th√≠ nghi·ªám h·ª£p l·ªá. Xem Console v√† ph·∫£n h·ªìi.");
                    responseContainer.innerText = `L·ªói JSON: ${parseError.message}\n\nChu·ªói ƒë√£ c·ªë g·∫Øng ph√¢n t√≠ch:\n${jsonStringToParse}\n\nPh·∫£n h·ªìi g·ªëc t·ª´ AI:\n${rawAIResponseText}`;
                    aiExplanationContainer.classList.add('hidden');
                }

            } catch (error) {
                 clearTimeout(timeoutId);
                 if (error.name === 'AbortError') {
                    console.error("Y√™u c·∫ßu AI ƒë√£ h·∫øt th·ªùi gian ch·ªù.");
                    updateAIStatus('error-text', 'Y√™u c·∫ßu AI qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i.');
                 } else {
                    console.error("L·ªói khi g·ªçi Gemini API:", error);
                    updateAIStatus('error-text', `L·ªói giao ti·∫øp v·ªõi AI: ${error.message}.`);
                 }
                responseContainer.innerText = `L·ªói: ${error.message}.`;
            } finally {
                buttonText.textContent = 'T·∫°o Th√≠ Nghi·ªám';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                if (auth.currentUser && currentExperimentData) {
                    saveExperimentButton.disabled = false;
                }
            }
        });

        function handleAIDirectedExperiment(experimentData) {
            if (experimentData.aiExplanation) {
                aiExplanationText.innerText = experimentData.aiExplanation;
                aiExplanationContainer.classList.remove('hidden');
            } else {
                aiExplanationContainer.classList.add('hidden');
            }
            initMatterSimulationFromAI(experimentData);
        }
        
        saveExperimentButton.addEventListener('click', async () => { /* ... gi·ªØ nguy√™n ... */ });

        function initCharts() {
            destroyCharts(); 
            isChartRecording = true;
            fullChartData = { time: [], velocityX: [], velocityY: [] };

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Th·ªùi gian (s)'} },
                    y: { beginAtZero: false, title: { display: true } }
                },
                elements: { point: { radius: 1 } }, 
                animation: false 
            };

            const velocityXCtx = velocityXChartCanvas.getContext('2d');
            velocityXChart = new Chart(velocityXCtx, {
                type: 'line',
                data: { labels: [], datasets: trackedBodies.map((body, index) => ({
                    label: `V·∫≠n t·ªëc X V·∫≠t ${index + 1}`,
                    data: [],
                    borderColor: chartColors[index % chartColors.length],
                    tension: 0.1
                }))},
                options: { ...commonChartOptions, scales: { ...commonChartOptions.scales, y: { ...commonChartOptions.scales.y, title: { ...commonChartOptions.scales.y.title, text: 'V·∫≠n t·ªëc Ox (m/s)'}}}}
            });

            const velocityYCtx = velocityYChartCanvas.getContext('2d');
            velocityYChart = new Chart(velocityYCtx, {
                type: 'line',
                data: { labels: [], datasets: trackedBodies.map((body, index) => ({
                    label: `V·∫≠n t·ªëc Y V·∫≠t ${index + 1}`,
                    data: [],
                    borderColor: chartColors[index % chartColors.length],
                    tension: 0.1
                }))},
                options: { ...commonChartOptions, scales: { ...commonChartOptions.scales, y: { ...commonChartOptions.scales.y, title: { ...commonChartOptions.scales.y.title, text: 'V·∫≠n t·ªëc Oy (m/s)'}}}}
            });

            chartStatus.textContent = "ƒêang ghi d·ªØ li·ªáu...";
            exportVelocityXChartBtn.disabled = true;
            exportVelocityYChartBtn.disabled = true;
        }

        function destroyCharts() {
            if (velocityXChart) velocityXChart.destroy();
            if (velocityYChart) velocityYChart.destroy();
            velocityXChart = null;
            velocityYChart = null;
            isChartRecording = false;
            chartStatus.textContent = "Ch·ªçn th√≠ nghi·ªám ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªì th·ªã.";
            if(exportVelocityXChartBtn) exportVelocityXChartBtn.disabled = true;
            if(exportVelocityYChartBtn) exportVelocityYChartBtn.disabled = true;
        }

        function updateChartData() {
            if (isPaused || !isChartRecording || trackedBodies.length === 0 || !currentExperimentData || !render) return;

            const allBodiesSleeping = trackedBodies.every(body => body.speed < SLEEP_SPEED_THRESHOLD);
            if(allBodiesSleeping) {
                sleepCounter++;
            } else {
                sleepCounter = 0;
            }

            if (sleepCounter > SLEEP_THRESHOLD_COUNT) {
                isChartRecording = false;
                chartStatus.textContent = "ƒê√£ d·ª´ng ghi: V·∫≠t th·ªÉ ƒë√£ d·ª´ng l·∫°i. S·∫µn s√†ng t·∫£i xu·ªëng.";
                
                velocityXChart.data.labels = fullChartData.time;
                velocityYChart.data.labels = fullChartData.time;
                trackedBodies.forEach((body, index) => {
                    velocityXChart.data.datasets[index].data = fullChartData.velocityX[index];
                    velocityYChart.data.datasets[index].data = fullChartData.velocityY[index];
                });
                velocityXChart.update();
                velocityYChart.update();

                exportVelocityXChartBtn.disabled = false;
                exportVelocityYChartBtn.disabled = false;
                return;
            }

            const scale = currentExperimentData.worldParameters.simulationScale_pixels_per_meter;
            
            if (lastTimestamp === 0) lastTimestamp = performance.now();
            const currentTimestamp = performance.now();
            const deltaTimeSeconds = (currentTimestamp - lastTimestamp) / 1000;
            simulationTime += deltaTimeSeconds;
            lastTimestamp = currentTimestamp;
            
            const currentTime = simulationTime.toFixed(2);
            fullChartData.time.push(currentTime);

            trackedBodies.forEach((body, index) => {
                const assumedFPS = 60; 
                const velocityX_m_s = (body.velocity.x * assumedFPS) / scale;
                const velocityY_m_s = -(body.velocity.y * assumedFPS) / scale; 
                
                if(!fullChartData.velocityX[index]) fullChartData.velocityX[index] = [];
                if(!fullChartData.velocityY[index]) fullChartData.velocityY[index] = [];

                fullChartData.velocityX[index].push(velocityX_m_s.toFixed(2));
                fullChartData.velocityY[index].push(velocityY_m_s.toFixed(2));
            });

            const maxLivePoints = 150;
            velocityXChart.data.labels = fullChartData.time.slice(-maxLivePoints);
            velocityYChart.data.labels = fullChartData.time.slice(-maxLivePoints);
            
            trackedBodies.forEach((body, index) => {
                 velocityXChart.data.datasets[index].data = fullChartData.velocityX[index].slice(-maxLivePoints);
                 velocityYChart.data.datasets[index].data = fullChartData.velocityY[index].slice(-maxLivePoints);
            });
            
            velocityXChart.update('none'); 
            velocityYChart.update('none');
        }

        function initMatterSimulationFromAI(experimentData) {
            if (!Matter || !experimentData) { matterStatus.textContent = "L·ªói: D·ªØ li·ªáu th√≠ nghi·ªám kh√¥ng h·ª£p l·ªá..."; return; }
            matterStatus.textContent = "ƒêang kh·ªüi t·∫°o m√¥ ph·ªèng t·ª´ AI...";
            destroyCharts(); 
            trackedBodies = []; 
            simulationTime = 0; 
            lastTimestamp = 0; 
            sleepCounter = 0;
            isPaused = false;
            pauseResumeButton.textContent = 'T·∫°m D·ª´ng';

            if (render && render.canvas) render.canvas.remove();
            if (runner) Runner.stop(runner);
            if (engine) {
                Events.off(engine, 'afterUpdate', updateChartData); 
                Engine.clear(engine);
            }

            engine = Engine.create();
            const world = engine.world;
            const worldParams = experimentData.worldParameters;
            engine.world.gravity.y = (worldParams.gravity_y_m_s2 / 9.81);
            const scale = worldParams.simulationScale_pixels_per_meter;
            const containerWidth = canvasContainer.clientWidth;
            let containerHeight = canvasContainer.clientHeight;
            if (containerHeight <= 0 && containerWidth > 0) containerHeight = Math.max(300, containerWidth * (3/4));
            else if (containerHeight <= 0 && containerWidth <= 0) containerHeight = 300;

            render = Render.create({ element: canvasContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: '#e2e8f0' }});
            runner = Runner.create();
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, { mouse: mouse, constraint: { stiffness: 0.2, render: { visible: false } } });
            Composite.add(world, mouseConstraint);
            render.mouse = mouse;
            
            const ground = Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, 60, { isStatic: true, render: { fillStyle: '#475569' } });
            if (experimentData.experimentType !== 'collision') {
                Composite.add(world, [ground]);
            }

            experimentData.objects.forEach((objData) => {
                let body;
                const props = objData.physicalProperties || {}; 
                const initialX_px = (objData.initialPosition_m.x * scale);
                
                let y_position_px;
                if (experimentData.experimentType === 'collision') {
                    y_position_px = containerHeight / 2;
                } else {
                    y_position_px = containerHeight - 60 - (objData.initialPosition_m.y_from_ground * scale);
                }

                const options = {
                    restitution: props.restitution === undefined ? 0.5 : props.restitution,
                    friction: props.friction === undefined ? 0.1 : props.friction,
                    frictionAir: props.frictionAir === undefined ? 0.01 : props.frictionAir,
                    isStatic: objData.isStatic || false,
                    render: { fillStyle: objData.color || '#3498db' }
                };

                if (objData.shape === "rectangle") {
                    const width_px = objData.dimensions_m.width * scale;
                    const height_px = objData.dimensions_m.height * scale;
                    if (!options.isStatic && experimentData.experimentType !== 'collision') y_position_px -= height_px / 2;
                    body = Bodies.rectangle(initialX_px, y_position_px, width_px, height_px, options);
                } else { 
                    const radius_px = objData.dimensions_m.radius * scale;
                    if (!options.isStatic && experimentData.experimentType !== 'collision') y_position_px -= radius_px;
                    body = Bodies.circle(initialX_px, y_position_px, radius_px, options);
                }

                if (body) {
                    if (objData.mass_kg && !options.isStatic) Body.setMass(body, objData.mass_kg);
                    if (typeof objData.angle_degrees !== 'undefined') Body.setAngle(body, objData.angle_degrees * (Math.PI / 180));
                    
                    Composite.add(world, body);
                    
                    if (!body.isStatic) trackedBodies.push(body);

                    if (objData.initialVelocity_m_s) {
                        let { vx: vx_m_s = 0, vy: vy_m_s = 0 } = objData.initialVelocity_m_s;
                        const vx_px_s = vx_m_s * scale; 
                        const vy_px_s = -vy_m_s * scale;
                        const assumedFPS = 60;
                        Body.setVelocity(body, { x: vx_px_s / assumedFPS, y: vy_px_s / assumedFPS });
                    }
                }
            });

            if (trackedBodies.length > 0) initCharts(); 
            else destroyCharts();
            
            Events.on(engine, 'afterUpdate', updateChartData); 
            Render.run(render);
            Runner.run(runner, engine);
            matterStatus.textContent = experimentData.description || "M√¥ ph·ªèng t·ª´ AI ƒë√£ s·∫µn s√†ng!";
            [addBoxButton, addCircleButton, resetSimulationButton, pauseResumeButton].forEach(btn => btn.disabled = false);
        }
        
        function addManualBody(type) { /* ... gi·ªØ nguy√™n ... */ }
        addBoxButton.addEventListener('click', () => addManualBody('box'));
        addCircleButton.addEventListener('click', () => addManualBody('circle'));
        resetSimulationButton.addEventListener('click', () => { 
            destroyCharts(); 
            trackedBodies = [];
            simulationTime = 0;
            lastTimestamp = 0;
            pauseResumeButton.disabled = true;
            isPaused = false;
            pauseResumeButton.textContent = 'T·∫°m D·ª´ng';
            if (currentExperimentData) {
                initMatterSimulationFromAI(currentExperimentData);
            } else if (engine) {
                Events.off(engine, 'afterUpdate', updateChartData);
                Engine.clear(engine); 
                const groundHeightPx = 60;
                const ground = Bodies.rectangle(render.options.width / 2, render.options.height, render.options.width, groundHeightPx, { isStatic: true, render: { fillStyle: '#475569' } });
                Composite.add(engine.world, [ground]);
                matterStatus.textContent = "M√¥ ph·ªèng ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp (th·ªß c√¥ng).";
            }
         });
            
        function initPlaceholderSimulation() {
            if (!Matter) return;
            matterStatus.textContent = "S·∫µn s√†ng nh·∫≠n y√™u c·∫ßu t·ª´ AI ho·∫∑c th√™m v·∫≠t th·ªÉ th·ªß c√¥ng.";
            destroyCharts();
            trackedBodies = [];
            simulationTime = 0;
            lastTimestamp = 0;
            pauseResumeButton.disabled = true;
            isPaused = false;
            pauseResumeButton.textContent = 'T·∫°m D·ª´ng';
            
            if (render && render.canvas) render.canvas.remove();
            if (runner) Runner.stop(runner);
            if (engine) { 
                Events.off(engine, 'afterUpdate', updateChartData);
                Engine.clear(engine);
            }

            engine = Engine.create();
            engine.world.gravity.y = 1;
            const containerWidth = canvasContainer.clientWidth;
            let containerHeight = containerWidth > 0 ? containerWidth * 0.75 : 450;
            if (containerHeight <= 0) containerHeight = 450;
            
            render = Render.create({ element: canvasContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: '#e2e8f0' }});
            runner = Runner.create();
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, { mouse: mouse, constraint: { stiffness: 0.2, render: { visible: false } } });
            Composite.add(engine.world, mouseConstraint);
            render.mouse = mouse;
            const groundHeightPx = 60;
            const ground = Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, groundHeightPx, { isStatic: true, render: { fillStyle: '#475569' } });
            Composite.add(engine.world, [ground]);
            Render.run(render);
            Runner.run(runner, engine);
            [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = false);
        }

        function exportChart(chartInstance, filename) {
            if (!chartInstance) return;
            const a = document.createElement('a');
            a.href = chartInstance.toBase64Image();
            a.download = filename;
            a.click();
        }

        exportVelocityXChartBtn.addEventListener('click', () => exportChart(velocityXChart, 'do-thi-van-toc-x.png'));
        exportVelocityYChartBtn.addEventListener('click', () => exportChart(velocityYChart, 'do-thi-van-toc-y.png'));
        
        if (typeof Matter !== 'undefined') { initPlaceholderSimulation(); } 
        else { matterStatus.textContent = "L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c Matter.js."; [addBoxButton, addCircleButton, resetSimulationButton].forEach(btn => btn.disabled = true); }

        let resizeTimeout;
        window.addEventListener('resize', () => { 
            matterStatus.textContent = "Thay ƒë·ªïi k√≠ch th∆∞·ªõc...";
            [addBoxButton, addCircleButton, resetSimulationButton, pauseResumeButton].forEach(btn => btn.disabled = true);
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                if (currentExperimentData) { initMatterSimulationFromAI(currentExperimentData); } 
                else if (engine) { initPlaceholderSimulation(); }
            }, 300);
        });

        // --- Structured Form Logic ---
        experimentTypeSelect.addEventListener('change', () => {
            const selected = experimentTypeSelect.value;
            formFreeFall.classList.toggle('active', selected === 'free_fall');
            formProjectile.classList.toggle('active', selected === 'projectile');
            formIncline.classList.toggle('active', selected === 'incline');
            formCollision.classList.toggle('active', selected === 'collision');
        });

        generatePromptFromFormBtn.addEventListener('click', () => {
            const selected = experimentTypeSelect.value;
            let promptText = '';
            switch(selected) {
                case 'free_fall':
                    const ff_mass = document.getElementById('ff_mass').value || 1;
                    const ff_height = document.getElementById('ff_height').value || 10;
                    promptText = `Th·∫£ m·ªôt v·∫≠t n·∫∑ng ${ff_mass}kg t·ª´ ƒë·ªô cao ${ff_height} m√©t.`;
                    break;
                case 'projectile':
                    const p_mass = document.getElementById('p_mass').value || 1;
                    const p_velocity = document.getElementById('p_velocity').value || 15;
                    const p_angle = document.getElementById('p_angle').value || 30;
                    const p_height = document.getElementById('p_height').value || 0;
                    promptText = `N√©m m·ªôt v·∫≠t n·∫∑ng ${p_mass}kg v·ªõi v·∫≠n t·ªëc ${p_velocity}m/s theo g√≥c ${p_angle} ƒë·ªô t·ª´ ƒë·ªô cao ${p_height} m√©t.`;
                    break;
                case 'incline':
                    const i_angle = document.getElementById('i_angle').value || 25;
                    const i_mass = document.getElementById('i_mass').value || 1;
                    const i_friction = document.getElementById('i_friction').value || 0.1;
                    promptText = `M·ªôt kh·ªëi h·ªôp ${i_mass}kg tr∆∞·ª£t tr√™n m·∫∑t ph·∫≥ng nghi√™ng ${i_angle} ƒë·ªô c√≥ h·ªá s·ªë ma s√°t l√† ${i_friction}.`;
                    break;
                case 'collision':
                    const c1_mass = document.getElementById('c1_mass').value || 1;
                    const c1_vx = document.getElementById('c1_vx').value || 5;
                    const c1_vy = document.getElementById('c1_vy').value || 0;
                    const c2_mass = document.getElementById('c2_mass').value || 1;
                    const c2_vx = document.getElementById('c2_vx').value || -5;
                    const c2_vy = document.getElementById('c2_vy').value || 0;
                    const isElastic = document.getElementById('c_elastic').checked;
                    const collisionType = isElastic ? 'ƒë√†n h·ªìi' : 'm·ªÅm';
                    promptText = `M·ªôt v·∫≠t ${c1_mass}kg c√≥ v·∫≠n t·ªëc (vx=${c1_vx}, vy=${c1_vy}) va ch·∫°m ${collisionType} v·ªõi m·ªôt v·∫≠t ${c2_mass}kg c√≥ v·∫≠n t·ªëc (vx=${c2_vx}, vy=${c2_vy}).`;
                    break;
                default:
                    alert('Vui l√≤ng ch·ªçn m·ªôt lo·∫°i th√≠ nghi·ªám.');
                    return;
            }
            promptInput.value = promptText;
            promptInput.focus();
            promptInput.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => {
                promptInput.classList.remove('ring-2', 'ring-green-500');
            }, 1500);
        });

        pauseResumeButton.addEventListener('click', () => {
            if (!runner) return;
            isPaused = !isPaused;
            runner.enabled = !isPaused; 

            if (isPaused) {
                pauseResumeButton.textContent = 'Ti·∫øp T·ª•c';
                chartStatus.textContent = `ƒê√£ t·∫°m d·ª´ng.`;
            } else {
                pauseResumeButton.textContent = 'T·∫°m D·ª´ng';
                lastTimestamp = performance.now(); 
                if(isChartRecording) {
                   chartStatus.textContent = "ƒêang ghi d·ªØ li·ªáu...";
                }
            }
        });
    </script>
</body>
</html>
